<HTML>
<head>
<style>
#drop_zone{
border: 2px dashed #BBB;
border-radius: 5px;
padding: 25px;
text-align: center;
color: #BBB;
}
</style>
</head>

<body>

<div id="drop_zone">Drop files here</div>
<output id="list"></output>
<input type="button" id="uploadBtn" value="Upload!"></input>

<script>

var login = function(){
  
  var client = new XMLHttpRequest();
  client.open("post", "../../scrapi/login", true);
  client.send(JSON.stringify({username:"admin", password:"test"}));

  client.onreadystatechange = function(){
    if (client.readyState == 4 && client.status == 200){
      var res = JSON.parse(client.response);
      var tomorrow = new Date(Date.now() + 24*60*60 );
      localStorage.setItem("auth-token", res["auth-token"] );
      document.cookie="Authorization="+ res["auth-token"] +"; expires="+tomorrow.toUTCString()+"; path=/scrapi";
      console.log(document.cookie);
    }
  } 
}
login();

function upload(evt){

  console.log(localStorage.getItem("file"));
    
  var client = new XMLHttpRequest();
  
  client.open("post", "../../scrapi/group/other/upload", true);
  client.setRequestHeader("Content-Type", "application/json");
  client.setRequestHeader("Authorization", localStorage.getItem("auth-token"));
  var objUpload = {};
  objUpload.file = localStorage.getItem("file");
  fullname = localStorage.getItem("filename");
  var split = fullname.lastIndexOf(".")
  var filename = fullname;
  var extension = "";
  if(split != -1){
    filename = fullname.substring(0, split);
    extension = fullname.substring(split);
  }
  objUpload.name = filename;
  objUpload.extension = extension;
  objUpload.title = document.getElementById('fileTitle').value;
  client.send(JSON.stringify(objUpload));  /* Send to server */ 
     
   /* Check the response status */  
   client.onreadystatechange = function() 
   {
      if (client.readyState == 4 && client.status == 200) 
      {
         alert(client.statusText);
      }
   }
    
  
}

var uploadButton = document.getElementById('uploadBtn');
uploadButton.addEventListener('click', upload, false);

  function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    var files = evt.dataTransfer.files; // FileList object.

    // files is a FileList of File objects. List some properties.
    var output = [];
    f = files[0];
    
    var reader = new FileReader();
    reader.onloadend = function () {
      localStorage.setItem("file", btoa(reader.result));
      localStorage.setItem("filename", escape(f.name));
    }
    reader.readAsBinaryString(f);
    
      output.push('<li><input type="text" id="fileTitle"></input><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                  '</li>');
    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
  }

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
  }

  // Setup the dnd listeners.
  var dropZone = document.getElementById('drop_zone');
  dropZone.addEventListener('dragover', handleDragOver, false);
  dropZone.addEventListener('drop', handleFileSelect, false);
</script>

</body>
</HTML>
